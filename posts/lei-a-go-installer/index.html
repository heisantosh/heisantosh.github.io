<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><meta name=description content="Your site description"><link rel="shortcut icon" href=http://heisantosh.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>lei - a Go installer</title></head><body><header id=banner><h2><a href=http://heisantosh.github.io/>Delay Line Memory</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>lei - a Go installer</h1><time>August 25, 2020</time></header><p>A CLI tool to help install Go, written in Go!
or that&rsquo;s what I wanted to create!</p><blockquote><p><b>lexicon</b><br><i>word: lei, language:</em> Manipuri, noun 1. flower</i></p></blockquote><p>Whenever a new version of Go is released I have to download the tarball, extract it and replace the current installation. Usually I typed some commands in the command line to accomplish the task. I could use a shell script to accomplish it. There are already some tools which can install Go and even manage different versions and installations.</p><ul><li><a href=https://github.com/moovweb/gvm>gvm</a> - similar to nvm</li><li><a href=https://github.com/syndbg/goenv>goenv</a> - similar to pyenv</li></ul><p>And there is <a href=https://golang.org/doc/install#extra_versions>https://golang.org/doc/install#extra_versions</a>. It allows having multiple versions of Go with different names</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ go get golang.org/dl/go1.14
$ go1.14 download
Downloaded   0.0% <span class=o>(</span>    <span class=m>15120</span> / <span class=m>123550266</span> bytes<span class=o>)</span> ...
Downloaded   0.1% <span class=o>(</span>    <span class=m>64260</span> / <span class=m>123550266</span> bytes<span class=o>)</span> ...
Downloaded   4.1% <span class=o>(</span>  <span class=m>5095424</span> / <span class=m>123550266</span> bytes<span class=o>)</span> ...
....
&lt;snip snip&gt;
....
Downloaded  96.0% <span class=o>(</span><span class=m>118654867</span> / <span class=m>123550266</span> bytes<span class=o>)</span> ...
Downloaded 100.0% <span class=o>(</span><span class=m>123550266</span> / <span class=m>123550266</span> bytes<span class=o>)</span>
Unpacking /home/santosh/sdk/go1.14/go1.14.linux-amd64.tar.gz ...
Success. You may now run <span class=s1>&#39;go1.14&#39;</span>
$ go1.14 version
go version go1.14 linux/amd64
</code></pre></div><p>Probably this is the easiest way to install a new version as the command is built into the go tool. We can just set an alias to <code>go</code> for the current version we want to use.</p><h2 id=go-download-implementation>go download implementation</h2><p>Internal implementation for downloading and installing various Go versions.</p><p><a href=https://go.googlesource.com/dl/+/d149fc5456ffdf4b7d53e1893ec23f0585d414a0/>https://go.googlesource.com/dl/+/d149fc5456ffdf4b7d53e1893ec23f0585d414a0/</a>
internal/version/version.go#381</p><p><a href=https://go.googlesource.com/dl/>https://go.googlesource.com/dl/</a></p><p>Snippet from golang.org/dl/internal/version/version.go constructing the URL.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>versionArchiveURL</span><span class=p>(</span><span class=nx>version</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=nx>goos</span> <span class=o>:=</span> <span class=nf>getOS</span><span class=p>()</span>
	<span class=c1>// TODO: Maybe we should parse
</span><span class=c1></span>	<span class=c1>// https://storage.googleapis.com/go-builder-data/dl-index.txt ?
</span><span class=c1></span>	<span class=c1>// Let&#39;s just guess the URL for now and see if it&#39;s there.
</span><span class=c1></span>	<span class=c1>// Then we don&#39;t have to maintain that txt file too.
</span><span class=c1></span>	<span class=nx>ext</span> <span class=o>:=</span> <span class=s>&#34;.tar.gz&#34;</span>
	<span class=k>if</span> <span class=nx>goos</span> <span class=o>==</span> <span class=s>&#34;windows&#34;</span> <span class=p>{</span>
		<span class=nx>ext</span> <span class=p>=</span> <span class=s>&#34;.zip&#34;</span>
	<span class=p>}</span>
	<span class=nx>arch</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>GOARCH</span>
	<span class=k>if</span> <span class=nx>goos</span> <span class=o>==</span> <span class=s>&#34;linux&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>GOARCH</span> <span class=o>==</span> <span class=s>&#34;arm&#34;</span> <span class=p>{</span>
		<span class=nx>arch</span> <span class=p>=</span> <span class=s>&#34;armv6l&#34;</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=s>&#34;https://storage.googleapis.com/golang/&#34;</span> <span class=o>+</span> <span class=nx>version</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span> <span class=o>+</span> <span class=nx>goos</span> <span class=o>+</span> <span class=s>&#34;-&#34;</span> <span class=o>+</span> <span class=nx>arch</span> <span class=o>+</span> <span class=nx>ext</span>
<span class=p>}</span>
</code></pre></div><p>As mentioned in the comment in the code, <a href=https://storage.googleapis.com/go-builder-data/dl-index.txt>https://storage.googleapis.com/go-builder-data/dl-index.txt</a> is a list of download links for various Go versions. It can be parsed and use for providing a list of version numbers to select from.</p><p>This process can be used for forming the download link for a given Go version.</p><p>I started with a feeling that something needs to be fixed but it looks like the solutions are already there.</p><p>So, what do I need for my use case?</p><ul><li>Able to download latest go version</li><li>Able to switch to the new go version</li><li>Have <code>go</code> as an alias to the current version.</li></ul><p>The last point could have a downside for someone who frequently switched between different go versions. Using something like <code>go1.14</code> instead of <code>go</code> makes it clear which version is being used.</p><p>Normally I follow the steps provided at <a href=https://golang.org/doc/install#install>https://golang.org/doc/install#install</a>. This keeps the installation at <code>/usr/local</code>. If I want to reinstall Go, I have to do as root. It would be nice If I just have the installation under my home directory.</p><h2 id=user-interface>User interface</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=c1># install a go version</span>
$ lei install 1.15
$ <span class=c1># list available versions</span>
$ lei list
$ <span class=c1># set alias go to given version</span>
$ lei use 1.15
$ <span class=c1># update to latest Go version</span>
$ lei update
</code></pre></div><p>Now I&rsquo;m feeling like I have got the NIH(Not Invented Here) syndrome <b style=writing-mode:vertical-rl>:{</b></p><p>Anyway, this is a chance to write more Go code. So I&rsquo;ll go ahead and implement it.</p><h2 id=implementation>Implementation</h2><h3 id=install>install</h3><p><code>lei install 1.15</code> should install Go 1.15 but doesn&rsquo;t switch the current installation to version 1.15.</p><p><u>Approach 1:</u><br>A wrapper around shell commnands - wget, tar etc. This will be a straighforward implementation. But it relies on having the commands installed already.</p><p><u>Approach 2:</u><br>Use the code available in golang.org/dl/internal package. This should allow for a platform independant implemenation. On the other hand ideally one shouldn&rsquo;t rely on the internal package. It&rsquo;s not expected to be used by other packages hence internal.</p><p><u>Approach 3:</u><br>Find libraries implementing functions for downloading, extracting tarballs. This address the shortcomings of the above two approaches. Either we can extract the code from golang.org./dl/internal package or find other packages providing similar features or write my own one.</p><p>Place of installation?<br>Since it is intended to use without the need for root permissions. It can be placed in the $HOME directory.</p><p><code>$HOME/.lei/bin</code> - will contain <code>go</code>, which will be a symlink to the wanted Go version. Make an entry in <code>.profile</code> to include in <code>$PATH</code><br><code>$HOME/.lei/versions/</code> - subdirectories will be like <code>go.1.14</code>, <code>go.1.15</code> etc where each will contain an installation of the version.</p><p>Where will the tarball be downloaded?<br>For simplicity we can let it download in the current directory where <code>lei</code> is running.</p><h3 id=list>list</h3><p><code>lei list</code> should list of available Go versions. For more info it could add a status in the output indicating whether that version is already installed or not.</p><p><a href="https://pkg.go.dev/golang.org/x/website/internal/dl?tab=doc">https://pkg.go.dev/golang.org/x/website/internal/dl?tab=doc</a> contains a link which provides a JSON containing metadata bout different Go version and download file names.</p><p><a href="https://golang.org/dl/?mode=json">https://golang.org/dl/?mode=json</a> to get a fix number of last Go releases.<br><a href="https://golang.org/dl/?mode=json&include=all">https://golang.org/dl/?mode=json&include=all</a> to get for Go releases starting 1.14.</p><h3 id=use>use</h3><p><code>lei use 1.15</code> should update the <code>go</code> symlink to the Go version 1.15. If version 1.15 is not installed, it should be installed first.</p><h3 id=update>update</h3><p><code>lei update</code> should install the latest Go version and set to use it. It&rsquo;s like a combination of the <code>install</code> and <code>use</code> command.</p><h2 id=show-me-the-code>Show me the code!?</h2><p>It should live at - <a href=https://github.com/heisantosh/lei>https://github.com/heisantosh/lei</a></p></article></main><footer id=footer></footer></body></html>